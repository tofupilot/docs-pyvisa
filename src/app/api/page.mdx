export const metadata = {
  title: 'Runs API Reference',
  description:
    "Explore the different run endpoints available in TofuPilot's REST API to manage test runs programmatically.",
}

# REST API Reference

The TofuPilot REST API is the primary interface for programmatically uploading test runs to TofuPilot. {{ className: 'lead' }}

---

## Authentication

Authenticate your requests to access any endpoints in the TofuPilot API using OAuth2 with your API key.

<div className="not-prose mt-8">
  <Button href="/user-management#api-key" variant="text" arrow="right">
    Create your API key
  </Button>
</div>

Add the key to the request header using cURL:

```bash
curl https://tofupilot.com/v1/runs/create \
  -H "Authorization: Bearer {api-key}"
```

Keep your API key safe and [regenerate](/user-management#api-key) it if you suspect compromise.

---

## Create a run {{ tag: 'POST', label: '/v1/runs' }}

<Row>

  <Col>
    This endpoint allows you to create a new run.
    <Properties>
      <Property name="procedure_id" type="string, required">
        Unique identifier for the procedure. _Example: "FVT1"_
      </Property>
      <Property name="unit_under_test" type="record, required">
        Record of the unit under test.
      </Property>
      <Property name="serial_number" type="string, required" indent>
        Unit identifier. Creates a new unit if no match. _Example: "SN123456"_
      </Property>
      <Property name="part_number" type="string, optional" indent>
        Component identifier. Creates a new component if no match. _Example: "PN-001"_
      </Property>
      <Property name="revision" type="string, optional" indent>
        Component revision. Required if multiple revisions exist. _Example: "A"_
      </Property>
      <Property name="run_passed" type="boolean, required">
        Indicates if the run passed. _Example: true_
      </Property>
      <Property name="started_at" type="string, optional">
        ISO 8601 start time of the run. _Example: "2024-09-11T08:00:00Z"_
      </Property>
      <Property name="duration" type="string, optional">
      The duration of the run.

        - For REST API: Use the ISO 8601 duration format. _Example: "PT1H23M12S"_
        - For [Python Client](./clients/python): Use a [`timedelta`](https://docs.python.org/3/library/datetime.html#timedelta-objects) object. _Example: `timedelta(hours=1, minutes=23, seconds=12)`_

      </Property>
      <Property name="steps" type="array, optional">
        [Steps](../steps) of the run.
      </Property>
      <Property name="name" type="string, required" indent>
        The name of the step. _Example: "temperature_calibration"_
      </Property>
      <Property name="step_passed" type="boolean, required" indent>
        Indicates if the step passed. _Example: true_
      </Property>
      <Property name="started_at" type="string, required" indent>
        ISO 8601 start time of the step. _Example: "2024-09-11T08:00:00Z"_
      </Property>
      <Property name="duration" type="string, required" indent>
        The duration of the step.

        - For REST API: Use the ISO 8601 duration format. _Example: "PT1H23M12S"_
        - For [Python Client](./clients/python): Use a [`timedelta`](https://docs.python.org/3/library/datetime.html#timedelta-objects) object. _Example: `timedelta(hours=1, minutes=23, seconds=12)`_

      </Property>
      <Property name="measurement_unit" type="string, optional" indent>
        The unit of measurement for the value. _Example: "Â°C"_
      </Property>
      <Property name="measurement_value" type="float, optional" indent>
        The value measured during step. _Example: 12.25_
      </Property>
      <Property name="limit_low" type="float, optional" indent>
        Minimum threshold. _Example: 11.44_
      </Property>
      <Property name="limit_high" type="float, optional" indent>
        Maximum threshold. _Example: 13.2_
      </Property>
      <Property name="attachments" type="array(string), optional">
        File paths for [attachments](../attachments). _Example: ["path/to/file1.png", "path/to/file2.pdf"]_
      </Property>
      <Property name="sub_units" type="array(record), optional">
        Identifiers of [sub-units](../sub-units).
      </Property>
      <Property name="serial_number" type="string, required" indent>
        Serial number of [sub-unit](../sub-units). _Example: "SN789"_
      </Property>
      <Property name="report_variables" type="record(string, string)">
        Key/value pairs for [report variables](../report).
      </Property>
    </Properties>

  </Col>
 
  <Col sticky>
    <CodeGroup title="Request" tag="POST" label="/v1/runs">

```python
from tofupilot import TofuPilotClient
from datetime import timedelta

client = TofuPilotClient()

client.create_run(
    procedure_id="FVT1",
    unit_under_test={
        "serial_number": '00102',
        "part_number": 'PCB01'
    },
    run_passed=True,
    duration=timedelta(minutes=27, seconds=15),
)
```

```bash {{ title: 'cURL' }}
curl -X POST https://www.tofupilot.com/api/v1/runs
  -H "Content-Type: application/json"
  -H "Authorization: Bearer <your_api_key>"
  -d '{
    "procedure_id": "FVT1",
    "unit_under_test": {
      "serial_number": "00102",
      "part_number": "PCB01"
    },
    "run_passed": true,
    "duration": "PT27M15S"
}'
```

```js
fetch('https://www.tofupilot.com/api/v1/runs', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    Authorization: 'Bearer <your_api_key>',
  },
  body: JSON.stringify({
    procedure_id: 'FVT1',
    unit_under_test: {
      serial_number: '00102',
      part_number: 'PCB01',
    },
    run_passed: true,
    duration: 'PT27M15S',
  }),
})
```

</CodeGroup>

```json {{ title: 'Response' }}
{
  "message": "Run created successfully: https://tofupilot.com/acme-corp/runs/your-new-run"
}
```

</Col>

</Row>

---

## Create a run from a file {{ tag: 'POST', label: '/v1/import' }}

<Row>
  <Col>
    This endpoint allows you to create a new run from a file report.
    <Properties>
      <Property name="file_path" type="string, required">
        The path to the log file to be imported.
      </Property>
      <Property name="importer" type="string, optional">
        The type of importer to use. Defaults to "OPENHTF".
      </Property>
    </Properties>
  </Col>

  <Col sticky>
    <CodeGroup title="Request" tag="POST" label="/v1/import">

```python
from tofupilot import TofuPilotClient

client = TofuPilotClient()

client.create_run_from_report(file_path="path/to/your/test/report.json", importer="OPENHTF")
```

```bash {{ title: 'cURL' }}
curl -X POST https://www.tofupilot.com/api/v1/import
  -H "Content-Type: application/json"
  -H "Authorization: Bearer <your_api_key>"
  -d '{
    "file_path": "path/to/your/test/report.json",
    "importer": "OPENHTF"
}'
```

```js
fetch('https://www.tofupilot.com/api/v1/import', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    Authorization: 'Bearer <your_api_key>',
  },
  body: JSON.stringify({
    file_path: 'path/to/your/test/report.json',
    importer: 'OPENHTF',
  }),
})
```

</CodeGroup>

```json {{ title: 'Response' }}
{
  "message": "Run created successfully: https://tofupilot.com/acme-corp/runs/your-new-run"
}
```

</Col>
</Row>

---

## Get runs by serial number {{ tag: 'GET', label: '/v1/units/?serial_number=<serial_number>' }}

<Row>
  <Col>
    This endpoint allows you to fetch all runs related to a specific unit.
    <Properties>
      <Property name="serial_number" type="string, required">
        The unique identifier of the unit associated with the runs.
      </Property>
    </Properties>
  </Col>

  <Col sticky>
    <CodeGroup title="Request" tag="GET" label="/v1/units?serial_number=<serial_number>">

```python
from tofupilot import TofuPilotClient

client = TofuPilotClient()

client.get_runs(serial_number="00102")
```

```bash {{ title: 'cURL' }}
curl -X POST https://www.tofupilot.com/api/v1/units?serial_number=<serial_number>
  -H "Content-Type: application/json"
  -H "Authorization: Bearer <your_api_key>"
```

```js
fetch('https://www.tofupilot.com/api/v1/units?serial_number=<serial_number>', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    Authorization: 'Bearer <your_api_key>',
  },
})
```

</CodeGroup>

```json {{ title: 'Response' }}
{
  "message": "Runs fetched successfuly.",
  "data": [
    {
      "duration": "PT12S",
      "createdAt": "2024-09-05T15:58:30.891Z",
      "startedAt": "2024-09-05T08:38:17.115Z",
      "createdBy": {
        "email": "user@acmecorp.com"
      },
      "status": {
        "name": "Pass",
        "category": "Successful"
      },
      "steps": [
        {
          "name": "measure_duration",
          "duration": "PT11S",
          "value": 5,
          "status": {
            "category": "Successful"
          },
          "units": "second",
          "lowLimit": 1,
          "highLimit": 10
        }
      ]
    }
  ]
}
```

</Col>
</Row>

---

## Errors

Whenever a request is unsuccessful, the TofuPilot API will return a response with a status code and error message.

### Status Codes

Here are the categories of status codes returned by the TofuPilot API:

<Properties>
  <Property name="2xx">
    A 2xx status code indicates a successful response.
  </Property>
  <Property name="4xx">A 4xx status code indicates a client error.</Property>
  <Property name="5xx">A 5xx status code indicates a server error.</Property>
</Properties>

### Error Messages

Use error messages to identify and fix issues. For example:

```bash {{ title: "Error response" }}
{
  "status_code": 404,
  "message": 'No procedure was found with the provided ID: "FVT2". Please verify the ID and try again. If the procedure does not exist, you can create a new one on the Procedures page in TofuPilot.'
}
```
