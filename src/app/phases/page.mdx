export const metadata = {
  title: 'Phases',
  description:
    'This guide shows how to create and add various test phases in TofuPilot and view the automatically generated reports, helping to identify frequent failures and time-consuming phases.',
}

# Phases

Organize your test flow by breaking it down into multiple phases. {{ className: 'lead' }}

<Image
  src="/phases-header.png"
  alt="Phases section header showing test phase management whithin TofuPilot."
/>

## Overview

A hardware test typically consists of several phases that perform measurements and validation. TofuPilot provides an easy way to record phase details and analyze performance across all executions, giving you precise analytics on phase failure rates and durations.

## Integration

You can create and add various test phases and view the automatically generated reports on the Run page.

### Required parameters

<CodeGroup>

```python {{ title: 'OpenHTF'}}
import openhtf as htf
from tofupilot.openhtf import TofuPilot

def phase_one(test):                      # Phase name is the function name
    return htf.PhaseResult.CONTINUE       # Pass status

def main():
    test = htf.Test(
        phase_one,
        procedure_id="FVT1",
        part_number="PCB1"
    )

    with TofuPilot(test):
        test.execute(lambda: "PCB1A001")  # duration and start time are automatically set

if __name__ == '__main__':
    main()
```

```python {{ title: 'Python'}}
from tofupilot import TofuPilotClient, PhaseOutcome
from datetime import datetime, timedelta

def phase_one():
    phase = [
        {
            "name": "phase_one",
            "outcome": PhaseOutcome.PASS,
            "duration": timedelta(seconds=30),
            "started_at": datetime.now(),
        }
    ]
    return phase

def main():
    phases = phase_one()

    client = TofuPilotClient()

    client.create_run(
        procedure_id="FVT1",
        unit_under_test={"serial_number": "PCB1A001", "part_number": "PCB1"},
        phases=phases,
        run_passed=all(phase["outcome"] == PhaseOutcome.PASS for phase in phases),
    )

if __name__ == "__main__":
    main()
```

</CodeGroup>

<Properties>
  <Property name="name" type="str">
    The name of the phase.
  </Property>
  <Property name="outcome" type='"PASS" | "FAIL" | "ERROR" | "SKIP", required'>
    Outcome of the phase. _Example: "PASS"_
  </Property>
  <Property name="started_at" type="datetime">
    ISO 8601 start time of the phase. Example: "2024-09-11T08:00:00Z"
  </Property>
  <Property name="duration" type="timedelta">
    The duration of the phase.
  </Property>
</Properties>

### Optional parameters

<CodeGroup>

```python {{ title: 'OpenHTF'}}
import openhtf as htf
from tofupilot.openhtf import TofuPilot

# Decorator to set measurement name, unit and limits
@htf.measures(
htf.Measurement("voltage")
.in_range(3.1, 3.5)
.with_units(units.VOLT)
)
# Phase returns a Pass status because measurement (3.3) is within defined limits [3.1, 3.5]
def phase_voltage_measure(test):
    test.measurements.voltage = 3.3

def main():
    test = htf.Test(
    phase_voltage_measure,
    procedure_id="FVT1",
    part_number="PCB1"
    )

    with TofuPilot(test):
        test.execute(lambda: "PCB1A001")

if __name__ == "__main__":
    main()
```

```python {{ title: 'Python'}}
from tofupilot import TofuPilotClient, PhaseOutcome, MeasurementOutcome
from datetime import datetime, timedelta

client = TofuPilotClient()

# Phase returns a Pass status because measurement (3.3) is within defined limits [3.1, 3.5]
def phase_voltage_measure():
    start_time_millis = datetime.now().timestamp() * 1000

    phase = {
        "name": "voltage_measure_phase",
        "outcome": PhaseOutcome.PASS,
        "start_time_millis": start_time_millis,
        "end_time_millis": start_time_millis
        + 30 * 1000,  # Indicating phase took 30 seconds to complete
        "measurements": [{
          "name": "voltage_measure",
          "units": "Volt",
          "lower_limit": 3.1,
          "upper_limit": 3.5,
          "measured_value": 3.3,
          "outcome": MeasurementOutcome.PASS
        }]
    }

    return phase


def main():
    phases = [phase_voltage_measure()]

    client.create_run(
        procedure_id="FVT1",
        unit_under_test={"serial_number": "PCB1A001", "part_number": "PCB1"},
        phases=phases,
        run_passed=all(phase["outcome"] == PhaseOutcome.PASS for phase in phases),
    )


if __name__ == "__main__":
    main()
```

</CodeGroup>

<Properties>
  <Property name="measurements" type="array, optional">
    The array of one or several measurement in one phase.
  </Property>
  <Property name="name" type="string, required" indent={1}>
    The name of one measurement.
  </Property>
  <Property
    name="outcome"
    type='"PASS" | "FAIL" | "UNSET", required'
    indent={1}
  >
    Outcome of the measurement. _Example: "PASS"_
  </Property>
  <Property
    name="measured_value"
    type="number | string | boolean | JSON, optional"
    indent={1}
  >
    The value of the measurement.
  </Property>
  <Property name="units" type="string, optional" indent={1}>
    The units of the value. _Examples: Celsius Degrees, Voltage_
  </Property>
  <Property name="lower_limit" type="number, optional" indent={1}>
    Minimum threshold. **Only taken into account if measured_value is a
    number**. _Example: 3.2V_
  </Property>
  <Property name="upper_limit" type="number, optional" indent={1}>
    Maximum threshold. **Only taken into account if measured_value is a
    number**. _Example: 13.2V_
  </Property>
</Properties>

## In-app view

### Run page

You can view each test phase in the **Phases** section on the Run page.

<Image
  src="/phases-page-run.png"
  alt="Phases section header showing test phase management whithin TofuPilot."
/>

### Procedure Page

Clicking on a test phase from the **Run** page redirects you to the **Procedure** page, where you can see all executed runs of this procedure, sorted by that phase. You can navigate between different tabs to view the average **Duration** for each phase, the **Yields**, quantity of **Runs**, and **Cpk**.

<Image
  src="/phases-page-procedure1.png"
  alt="Phases section header showing test phase management whithin TofuPilot."
/>

You can view phase details in the tabs or the **Control Chart** by clicking on a phase (e.g., `phase_one`). The Control Chart displays limits `lower_limit` and `upper_limit` and the 6-sigma standard deviation, calculated automatically.

<Note>
  If the limit definitions have changed over time, the most recent limits
  provided will be used.
</Note>

<Image
  src="/phases-page-procedure2.png"
  alt="Phases section header showing test phase management whithin TofuPilot."
/>

To unselect a phase, click its name on the top bar of the page or click on **Clear Filter**.

---

## Advanced integration

You can find an example of Phases functionalities in this script, including measured values, limits, units, and multiple measurements.

<CodeGroup>

```python {{ title: 'OpenHTF' }}
import openhtf as htf
from tofupilot.openhtf import TofuPilot
from openhtf.util import units

# Phase without measurement
def phase_connect():
    htf.PhaseResult.CONTINUE

# Phase with one measure
@htf.measures(htf.Measurement("firmware_version").equals("v2.5.1"))
def phase_firmware_version_check(test):
    test.measurements.firmware_version = "v2.5.1"

# Phase with multiple measurements
@htf.measures(
    htf.Measurement("input_voltage").in_range(3.1, 3.5).with_units(units.VOLT),
    htf.Measurement("output_voltage").in_range(1.1, 1.3).with_units(units.VOLT),
)
def phase_voltage_measurements(test):
    test.measurements.input_voltage = 3.3
    test.measurements.output_voltage = 1.2

def main():
    test = htf.Test(
        phase_connect,
        phase_firmware_version_check,
        phase_voltage_measurements,
        procedure_id="FVT2",
        procedure_name="Functional PCBA Testing",
        part_number="PCB1",
    )

    with TofuPilot(test):
        test.execute(lambda: "PCB1A002")

if __name__ == "__main__":
    main()
```

```python {{ title: 'Python'}}
from tofupilot import TofuPilotClient, PhaseOutcome, MeasurementOutcome
from datetime import datetime, timedelta

def main():
    client = TofuPilotClient()

    client.create_run(
            procedure_id="FVT2",
            procedure_name="Functional PCBA Testing",
            unit_under_test={
                "serial_number": "PCB1A002",
                "part_number": "PCB1",
            },
            run_passed=True,
            phases=[
                # Phase without measurement
                {
                    "name": "phase_connect",
                    "outcome": PhaseOutcome.PASS,
                    "duration": timedelta(seconds=3),
                    "started_at": datetime.now(),
                },
                # Phase with measurement
                {
                    "name": "phase_firmware_version_check",
                    "outcome": PhaseOutcome.PASS,
                    "duration": timedelta(minutes=1, seconds=42),
                    "started_at": datetime.now() + timedelta(seconds=3),
                    "measurements": [
                        {
                            "name": "firmware_version",
                            "outcome": MeasurementOutcome.PASS,
                            "measured_value": "v2.5.1",
                        }
                    ],
                },
                # Phase with multiple measurements
                {
                    "name": "phase_voltage_measurements",
                    "outcome": PhaseOutcome.PASS,
                    "started_at": datetime.now(),
                    "duration": timedelta(seconds=30),
                    "measurements": [
                        {
                            "name": "input_voltage",
                            "outcome": MeasurementOutcome.PASS,
                            "measured_value": 3.3,
                            "units": "V",
                            "lower_limit": 3.1,
                            "upper_limit": 3.5,
                        },
                        {
                            "name": "output_voltage",
                            "outcome": MeasurementOutcome.PASS,
                            "measured_value": 1.2,
                            "units": "V",
                            "lower_limit": 1.1,
                            "upper_limit": 1.3,
                        },
                    ],
                },
            ],
        )

if __name__ == "__main__":
    main()
```

</CodeGroup>

You can see the result on the Run page.

<Image
  src="/phases-page-run2.png"
  alt="Phase section header showing test phase management whithin TofuPilot."
/>
