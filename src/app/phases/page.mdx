export const metadata = {
  title: 'Phases',
  description:
    'This guide shows how to create and add various test phases in TofuPilot and view the automatically generated reports, helping to identify frequent failures and time-consuming phases.',
}

# Phases

Organize your test flow by breaking it down into multiple phases. {{ className: 'lead' }}

<Image
  src="/steps-header.png"
  alt="Phases section header showing test phase management whithin TofuPilot."
/>

## Overview
A hardware test typically consists of several phases that perform measurements and validation. TofuPilot provides an easy way to record phase details and analyze performance across all executions, giving you precise analytics on phase failure rates and durations.


## Integration
You can create and add various test phases and view the automatically generated reports on the Run page.

### Required parameters
<CodeGroup>
```python {{ title: 'OpenHTF'}}
import openhtf as htf
from tofupilot.openhtf import TofuPilot

def phase_one(test):                      # Phase name is the function name
    return htf.PhaseResult.CONTINUE       # Pass status

def main():
    test = htf.Test(
        phase_one,
        procedure_id="FVT1",
        part_number="PCB1"
    )
    with TofuPilot(test):
        test.execute(lambda: "PCB1A001")  # duration and started_at are set automatically

if __name__ == '__main__':
    main()
```
```python {{ title: 'Python'}}
from tofupilot import TofuPilotClient
from datetime import datetime, timedelta

def phase_one():
    phase = [
        {
            "name": "phase_one",
            "phase_passed": True,
            "duration": timedelta(seconds=30),
            "started_at": datetime.now(),
        }
    ]
    return phase

def main():
    phases = phase_one()

    client = TofuPilotClient()

    client.create_run(
        procedure_id="FVT1",
        unit_under_test={"serial_number": "PCB1A001", "part_number": "PCB1"},
        phases=phases,
        run_passed=all(phase["phase_passed"] for phase in phases),
    )

if __name__ == "__main__":
    main()
```
</CodeGroup>

<Properties>
  <Property name="name" type="str">
    The name of the phase.
  </Property>
  <Property name="phase_passed" type="bool">
    Pass/Fail status of the phase.
  </Property>
  <Property name="started_at" type="datetime">
    ISO 8601 start time of the phase. Example: "2024-09-11T08:00:00Z"
  </Property>
  <Property name="duration" type="timedelta">
    The duration of the phase.
  </Property>
</Properties>

### Optional parameters

<CodeGroup>
```python {{ title: 'OpenHTF'}}
import openhtf as htf
from tofupilot.openhtf import TofuPilot

# Add decorator to set measurement name, unit and limits
@htf.measures(
    htf.Measurement("voltage")
    .in_range(3.1, 3.5)
    .with_units(units.VOLT)
)
# Phase return a Pass status due to measurement (3.3) within defined limits [3.1, 3.5]
def phase_voltage_measure(test):
    test.measurements.voltage = 3.3

def main():
    test = htf.Test(
        phase_voltage_measure,
        procedure_id="FVT1",
        part_number="PCB1"
    )
    with TofuPilot(test):
        test.execute(lambda: "PCB1A001")

if __name__ == '__main__':
    main()
```
```python {{ title: 'Python'}}
from tofupilot import TofuPilotClient
from datetime import datetime, timedelta

def phase_one():
    phase = [
        {
            "name": "phase_one",
            "phase_passed": True,
            "started_at": datetime.now(),
            "duration": timedelta(seconds=30),
            # Add a measurement with value, units and limits
            "measurement_unit": "V",
            "measurement_value": 3.3,
            "limit_low": 3.1,
            "limit_high": 3.5,
        }
    ]
    return phase

def main():
    phases = phase_one()

    client = TofuPilotClient()

    client.create_run(
        procedure_id="FVT1",
        unit_under_test={"serial_number": "PCB1A001", "part_number": "PCB1"},
        phases=phases,
        run_passed=all(phase["phase_passed"] for phase in phases),
    )

if __name__ == "__main__":
    main()
```
</CodeGroup>

<Properties>
  <Property name="measurement_unit" type="str">
    The unit of measurement for the value (e.g. "°C").
  </Property>
  <Property name="measurement_value" type="float">
    The value measured during phase.
  </Property>
  <Property name="limit_low" type="float">
    Minimum threshold.
  </Property>
  <Property name="limit_high" type="float">
    Maximum threshold.
  </Property>
</Properties>

## In-app view

### Run page
You can view each test phase in the **Phases** section on the Run page.

<Image
  src="/steps-page-run.png"
  alt="Phases section header showing test phase management whithin TofuPilot."
/>

### Procedure Page
Clicking on a test phase from the **Run** page redirects you to the **Procedure** page, where you can see all executed runs of this procedure, sorted by that phase. You can navigate between different tabs to view the average **Duration** for each phase, the **Yields**, quantity of **Runs**, and **Cpk**.


<Image
  src="/steps-page-procedure1.png"
  alt="Phases section header showing test phase management whithin TofuPilot."
/>

You can view phase details in the tabs or the **Control Chart** by clicking on a phase (e.g., `phase_one`). The Control Chart displays limits `limit_low` and `limit_high` and the 6-sigma standard deviation, calculated automatically.


<Note>
  If the limit definitions have changed over time, the most recent limits
  provided will be used.
</Note>


<Image
  src="/steps-page-procedure2.png"
  alt="Phases section header showing test phase management whithin TofuPilot."
/>

To unselect a phase, click its name on the top bar of the page or click on **Clear Filter**.

---

## Advanced integration

You can find an example of Phases functionalities in this script, including measured values, limits, and units.

<CodeGroup>

```python {{ title: 'OpenHTF' }}
import openhtf as htf
from tofupilot.openhtf import TofuPilot
from openhtf.util import units

def phase_connect():
    htf.PhaseResult.CONTINUE

@htf.measures(htf.Measurement("firmware_version").equals("v2.5.1"))
def phase_firmware_version_check(test):
    test.measurements.firmware_version = "v2.5.1"

@htf.measures(
    htf.Measurement("temperature").in_range(70, 80).with_units(units.DEGREE_CELSIUS)
)
def phase_temperature_calibration(test):
    test.measurements.temperature = 75

def main():
    test = htf.Test(
        phase_connect,
        phase_firmware_version_check,
        phase_temperature_calibration,
        procedure_id="FVT2",
        procedure_name="PCB Temperature Calibration",
        part_number="PCB1",
    )
    with TofuPilot(test):
        test.execute(lambda: "PCB1A002")

if __name__ == "__main__":
    main()
```

```python {{ title: 'Python'}}
from tofupilot import TofuPilotClient
from datetime import datetime, timedelta

def main():
    client = TofuPilotClient()

    client.create_run(
        procedure_id="FVT2",
        procedure_name="PCB Temperature Calibration",
        unit_under_test={
            "serial_number": "PCB1A002",
            "part_number": "PCB1",
        },
        run_passed=True,
        phases=[
            {
                "name": "phase_connect",
                "phase_passed": True,
                "duration": timedelta(seconds=3),
                "started_at": datetime.now(),
            },
            {
                "name": "test_firmware_version_check",
                "phase_passed": True,
                "duration": timedelta(minutes=1, seconds=42),
                "started_at": datetime.now() + timedelta(seconds=3),
                "measurement_value": "v2.5.1",
            },
            {
                "name": "phase_temp_calibration",
                "phase_passed": True,
                "duration": timedelta(milliseconds=500),
                "started_at": datetime.now() + timedelta(seconds=4),
                "measurement_value": 75,
                "measurement_unit": "°C",
                "limit_low": 70,
                "limit_high": 80,
            },
        ],
    )

if __name__ == "__main__":
    main()
```
</CodeGroup>

You can see the result on the Run page.

<Image
  src="/phases-page-run2.png"
  alt="Phase section header showing test phase management whithin TofuPilot."
/>
