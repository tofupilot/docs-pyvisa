export const metadata = {
  title: 'Steps',
  description:
    'This guide shows how to create and add various test steps in Tofupilot and view the automatically generated reports, helping to identify frequent failures and time-consuming steps.',
}

# Steps
Organize your test flow by breaking it down into multiple steps. {{ className: 'lead' }}

<Image
  src="/steps-header.png"
  alt="Steps section header showing test step management whithin TofuPilot."
/>

## Overview
A hardware test typically consists of several steps that perform measurements and validation. TofuPilot provides an easy way to record step details and analyze performance across all executions, giving you precise analytics on phase failure rates and durations.


## Integration
You can create and add various test steps and view the automatically generated reports on the Run page.

### Required parameters
<Properties>
  <Property name="name" type="str">
    The name of the step.
  </Property>
  <Property name="step_passed" type="bool">
    Pass/Fail status of the step.
  </Property>
  <Property name="started_at" type="datetime">
    ISO 8601 start time of the step. Example: "2024-09-11T08:00:00Z"
  </Property>
  <Property name="duration" type="timedelta">
    The duration of the step.
  </Property>
</Properties>

<CodeGroup>
```python {{ title: 'OpenHTF'}}
import openhtf as htf
from tofupilot.openhtf import TofuPilot

def step_one(test):                       # Step name is the function name
    return htf.PhaseResult.CONTINUE       # Pass status

def main():
    test = htf.Test(
        step_one,
        procedure_id="FVT1",
        part_number="PCB1"
    )
    with TofuPilot(test):
        test.execute(lambda: "PCB1A001")  # duration and started_at are set automatically

if __name__ == '__main__':
    main()
```
```python {{ title: 'Python'}}
from tofupilot import TofuPilotClient
from datetime import datetime, timedelta

def step_one():
    step = [
        {
            "name": "step_one",
            "step_passed": True,
            "duration": timedelta(seconds=30),
            "started_at": datetime.now(),
        }
    ]
    return step

def main():
    steps = step_one()

    client = TofuPilotClient()

    client.create_run(
        procedure_id="FVT1",
        unit_under_test={"serial_number": "PCB1A001", "part_number": "PCB1"},
        steps=steps,
        run_passed=all(step["step_passed"] for step in steps),
    )

if __name__ == "__main__":
    main()
```
</CodeGroup>



### Optional parameters
<Properties>
  <Property name="measurement_unit" type="str">
    The unit of measurement for the value (e.g. "°C").
  </Property>
  <Property name="measurement_value" type="float">
    The value measured during step.
  </Property>
  <Property name="limit_low" type="float">
    Minimum threshold.
  </Property>
  <Property name="limit_high" type="float">
    Maximum threshold.
  </Property>
</Properties>


<CodeGroup>
```python {{ title: 'OpenHTF'}}
import openhtf as htf
from tofupilot.openhtf import TofuPilot

# Add decorator to set measurement name, unit and limits
@htf.measures(
    htf.Measurement("voltage")
    .in_range(3.1, 3.5)
    .with_units(units.VOLT)
)
# Step return a Pass status due to measurement (3.3) within defined limits [3.1, 3.5]
def step_voltage_measure(test):
    test.measurements.voltage = 3.3

def main():
    test = htf.Test(
        step_voltage_measure,
        procedure_id="FVT1",
        part_number="PCB1"
    )
    with TofuPilot(test):
        test.execute(lambda: "PCB1A001")

if __name__ == '__main__':
    main()
```
```python {{ title: 'Python'}}
from tofupilot import TofuPilotClient
from datetime import datetime, timedelta

def step_one():
    step = [
        {
            "name": "step_one",
            "step_passed": True,
            "started_at": datetime.now(),
            "duration": timedelta(seconds=30),
            # Add a measurement with value, units and limits
            "measurement_unit": "V",
            "measurement_value": 3.3,
            "limit_low": 3.1,
            "limit_high": 3.5,
        }
    ]
    return step

def main():
    steps = step_one()

    client = TofuPilotClient()

    client.create_run(
        procedure_id="FVT1",
        unit_under_test={"serial_number": "PCB1A001", "part_number": "PCB1"},
        steps=steps,
        run_passed=all(step["step_passed"] for step in steps),
    )

if __name__ == "__main__":
    main()
```
</CodeGroup>

## In-app view

### Run page
You can view each test step in the **Steps** section on the Run page.

<Image
  src="/steps-page-run.png"
  alt="Steps section header showing test step management whithin TofuPilot."
/>

### Procedure Page
Clicking on a test step from the **Run** page redirects you to the **Procedure** page, where you can see all executed runs of this procedure, sorted by that step. You can navigate between different tabs to view the average **Duration** for each step, the **Yields**, quantity of **Runs**, and **Cpk**.


<Image
  src="/steps-page-procedure1.png"
  alt="Steps section header showing test step management whithin TofuPilot."
/>

You can view step details in the tabs or the **Control Chart** by clicking on a step (e.g., `step_one`). The Control Chart displays limits `limit_low` and `limit_high` and the 6-sigma standard deviation, calculated automatically.


<Note>
  If the limit definitions have changed over time, the most recent limits
  provided will be used.
</Note>


<Image
  src="/steps-page-procedure2.png"
  alt="Steps section header showing test step management whithin TofuPilot."
/>

To unselect a step, click its name on the top bar of the page or click on **Clear Filter**.

---

## Advanced integration

You can find an example of Steps functionalities in this script, including measured values, limits, and units.

<CodeGroup>

```python {{ title: 'OpenHTF' }}
import openhtf as htf
from tofupilot.openhtf import TofuPilot
from openhtf.util import units

def step_connect():
    htf.PhaseResult.CONTINUE

@htf.measures(htf.Measurement("firmware_version").equals("v2.5.1"))
def step_firmware_version_check(test):
    test.measurements.firmware_version = "v2.5.1"

@htf.measures(
    htf.Measurement("temperature").in_range(70, 80).with_units(units.DEGREE_CELSIUS)
)
def step_temperature_calibration(test):
    test.measurements.temperature = 75

def main():
    test = htf.Test(
        step_connect,
        step_firmware_version_check,
        step_temperature_calibration,
        procedure_id="FVT2",
        procedure_name="PCB Temperature Calibration",
        part_number="PCB1",
    )
    with TofuPilot(test):
        test.execute(lambda: "PCB1A002")

if __name__ == "__main__":
    main()
```

```python {{ title: 'Python'}}
from tofupilot import TofuPilotClient
from datetime import datetime, timedelta

def main():
    client = TofuPilotClient()

    client.create_run(
        procedure_id="FVT2",
        procedure_name="PCB Temperature Calibration",
        unit_under_test={
            "serial_number": "PCB1A002",
            "part_number": "PCB1",
        },
        run_passed=True,
        steps=[
            {
                "name": "step_connect",
                "step_passed": True,
                "duration": timedelta(seconds=3),
                "started_at": datetime.now(),
            },
            {
                "name": "test_firmware_version_check",
                "step_passed": True,
                "duration": timedelta(minutes=1, seconds=42),
                "started_at": datetime.now() + timedelta(seconds=3),
                "measurement_value": "v2.5.1",
            },
            {
                "name": "step_temp_calibration",
                "step_passed": True,
                "duration": timedelta(milliseconds=500),
                "started_at": datetime.now() + timedelta(seconds=4),
                "measurement_value": 75,
                "measurement_unit": "°C",
                "limit_low": 70,
                "limit_high": 80,
            },
        ],
    )

if __name__ == "__main__":
    main()
```
</CodeGroup>

You can see the result on the Run page.

<Image
  src="/steps-page-run2.png"
  alt="Steps section header showing test step management whithin TofuPilot."
/>
