export const metadata = {
  title: 'Steps',
  description:
    'This guide shows how to create and add various test steps in Tofupilot and view the automatically generated reports, helping to identify frequent failures and time-consuming steps.',
}

# Steps

Hardware manufacturing tests often involve multiple steps such as connections, measurements, calibration, and more. Tofupilot offers a simple way to record the details of these steps and analyze their performance across all executions. {{ className: 'lead' }}

This guide shows how to create and add various test steps in Tofupilot and view the automatically generated reports. This helps you quickly identify frequent failures and time-consuming steps, allowing you to focus on improvements.

## Simple example

```python {{ title: 'create_run_with_steps_simple.py'}}
from tofupilot import TofuPilotClient
from datetime import datetime, timedelta

client = TofuPilotClient()

client.create_run(
    procedure_id="FVT1",
    unit_under_test={
      "serial_number": "00102",
    },
    run_passed=True,  # Overall run status
    steps=[{
      "name": "Power On Self Test",
      "step_passed": True,  # Status of the step
      "duration": timedelta(minutes=2, seconds=30),  # Duration of the step
      "started_at": datetime.now(),  # Start time of the step
    }],
)
```

## Complete example

This script shows a complete example of all TofuPilot's steps functionnality.

<Note>
  This example is designed to be framework-agnostic and does not offer any
  sequencing logic. For manufacturing deployments, we recommend using proven
  test sequencers like [PyTest](https://docs.pytest.org/en/8.2.x/),
  [OpenHTF](https://www.openhtf.com/), or your own.
</Note>

```python {{ title: 'create_run_with_steps_complete.py'}}
from tofupilot import TofuPilotClient
from datetime import datetime, timedelta

client = TofuPilotClient()

client.create_run(
    procedure_id="FVT1",
    unit_under_test={
        "serial_number": "00102",
    },
    run_passed=True,  # Overall run status
    steps=[
        {
            "name": "step_connect",  # First step
            "step_passed": True,  # Status of the step
            "duration": timedelta(seconds=3),  # Duration of the step
            "started_at": datetime.now(),  # Start time of the step
        },
        {
            "name": "step_initial_charge_check",  # Second step
            "step_passed": True,  # Status of the step
            "duration": timedelta(milliseconds=500),  # Duration of the step (<1s)
            "started_at": datetime.now() + timedelta(seconds=3),  # Start time of the second step
            "measurement_value": 80,  # Measured value
        },
        {
            "name": "step_initial_temp_check",  # Third step
            "step_passed": True,  # Status of the step
            "duration": timedelta(milliseconds=500),  # Duration of the step (<1s)
            "started_at": datetime.now() + timedelta(seconds=3, milliseconds=500),  # Start time of the third step
            "measurement_value": 72,  # Measured temperature value
            "measurement_unit": "°C",  # Unit of the measurement (temperature)
            "limit_low": 0,  # Lower limit of acceptable temperature
        },
        {
            "name": "step_temp_calibration",  # Fourth step
            "step_passed": True,  # Status of the step
            "duration": timedelta(milliseconds=500),  # Duration of the step (<1s)
            "started_at": datetime.now() + timedelta(seconds=4),  # Start time of the fourth step
            "measurement_value": 75,  # Measured temperature value after calibration
            "measurement_unit": "°C",  # Unit of the measurement (temperature)
            "limit_low": 70,  # Lower limit of acceptable temperature
            "limit_high": 80  # Upper limit of acceptable temperature
        }
    ],
)
```

## Run Page

A dedicated **Steps** section is automatically created on the Run’s page.

<Image src="/steps-run.png" alt="Steps of Run" />

## Procedure Page

### Steps section

On the Procedure page, steps from all executed runs are grouped by name, with an overview showing the performance and average duration for each step across the runs:

<Image src="/steps-charts.png" alt="Steps Runs of Procedures" />

### Steps selection

To see a detailed overview of any step's performance, simply click on it.

### Steps analytics

After selecting a step, all the charts that were visible at the procedure run level are now accessible at the step level.

<Image src="/step-charts.png" alt="Analytics on selected step" />

### Steps Control Chart

If the selected step includes values and at least one defined limit (either a `low_limit` or `high_limit` or both), a new chart, called the “Control Chart” will be displayed. This chart visualizes the progression of all measured values for the step over time, compared against its limits.

<Image src="/step-control-chart.png" alt="Step control chart example" />

<Note>
  If the limit definitions have changed over time, the most recent limits
  provided will be used.
</Note>

### Steps deselection

To unselect a step, simply click on it's name on the topbar of the page

<Image src="/step-unselect.png" alt="Unselection of step" />

## Run Duration

If no total test duration is provided, it will be computed as the sum of the durations of all the steps. However, if a total test duration is specified, it will override the computed sum.

## API Reference

Each `step` in the `steps` array provided to `create_run` should include the following parameters:

### Required

<Properties>
  <Property name="name" type="string, required" indent>
    Step name.
  </Property>
  <Property name="step_passed" type="boolean, required" indent>
    Indicates if the step passed.
  </Property>
  <Property name="started_at" type="string, required" indent>
    ISO 8601 start time of the step.
  </Property>
  <Property name="duration" type="string, required" indent>
    ISO 8601 duration of the step.
  </Property>
</Properties>

### Optional

<Properties>
  <Property name="measurement_unit" type="string, optional" indent>
    Unit of measurement.
  </Property>
  <Property name="measurement_value" type="float, optional" indent>
    Measured value.
  </Property>
  <Property name="limit_low" type="float, optional" indent>
    Minimum threshold.
  </Property>
  <Property name="limit_high" type="float, optional" indent>
    Maximum threshold.
  </Property>
</Properties>
